<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NASA GIBS WMS Time Series Map</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS for map styling -->
	 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <!-- Leaflet JS for map functionality - Moved to head to ensure it loads before custom JS -->
	 <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
		integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
		crossorigin=""></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            overflow: hidden; /* Prevent body scroll when panel is open */
        }
        #map-container {
            display: flex;
            height: 95vh; /* Adjust height to fill viewport */
            width: 100%;
        }
        #control-panel {
            width: 300px; /* Default width for the panel */
            min-width: 300px; /* Ensure it doesn't shrink too much */
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-right: 1rem;
            transition: width 0.3s ease-in-out, min-width 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateX(0); /* Start visible */
            overflow-y: auto; /* Enable scrolling for controls if needed */
        }
        #control-panel.collapsed {
            width: 0;
            min-width: 0;
            padding: 0;
            margin-right: 0;
            transform: translateX(-100%); /* Hide by sliding left */
            overflow: hidden;
        }
        #map {
            flex-grow: 1; /* Map takes remaining space */
            height: 100%;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        #toggle-panel-button {
            position: absolute;
            top: 1rem;
            left: calc(300px + 1rem); /* Position next to the panel */
            z-index: 1000;
            transition: left 0.3s ease-in-out;
        }
        #toggle-panel-button.panel-collapsed {
            left: 1rem; /* Move to left when panel is collapsed */
        }
    </style>
</head>
<body class="p-4 bg-gray-100 flex flex-col items-center">

    <div class="container mx-auto p-6 bg-white rounded-xl shadow-lg mb-4">
        <h1 class="text-3xl font-bold mb-4 text-center text-gray-800">NASA GIBS WMS Date Navigator</h1>
        <p class="text-center text-gray-600">
            Explore a time-enabled WMS layer from NASA's Global Imagery Browse Services.
            Use the controls to navigate through the dates, select layers and styles, and adjust transparency.
        </p>
    </div>

    <div id="map-container">
        <!-- Collapsible Control Panel -->
        <div id="control-panel">
            <!-- Date Controls -->
            <div class="flex flex-col items-center justify-center space-y-4 mb-6">
                <div class="flex items-center w-full">
                    <button id="prev-day" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold shadow-md hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 mr-2">
                        &lt; Prev
                    </button>
                    <button id="next-day" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold shadow-md hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 ml-2">
                        Next &gt;
                    </button>
                </div>
                <div id="date-controls-container" class="flex flex-col items-center w-full hidden">
                    <span id="current-date-display" class="text-xl font-mono text-gray-700 mb-2"></span>
                    <select id="date-select" class="w-full text-center px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent cursor-pointer"></select>
                </div>
            </div>

            <!-- Layer Search and Results -->
            <div class="flex flex-col items-center justify-center space-y-4 mb-6">
                <div class="relative w-full">
                    <input type="text" id="layer-search" placeholder="Search for a layer..." class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                    <div id="loading-message" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-sm text-gray-500 italic hidden">
                        Loading capabilities...
                    </div>
                </div>
                <ul id="layer-list" class="w-full max-h-64 overflow-y-auto bg-white border border-gray-300 rounded-lg shadow-md mt-2">
                    <!-- Search results will be rendered here -->
                </ul>
            </div>
            
            <!-- Style Selector Container (initially hidden) -->
            <div id="style-selector-container" class="w-full flex items-center space-x-2 mt-4 hidden">
                <label for="style-select" class="text-gray-700 font-medium">Select Style:</label>
                <select id="style-select" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"></select>
            </div>
            
            <!-- Transparency Slider -->
            <div id="transparency-container" class="w-full flex items-center space-x-2 mt-4">
                <label for="transparency-slider" class="text-gray-700 font-medium">Transparency:</label>
                <input type="range" id="transparency-slider" min="0" max="1" step="0.01" value="1" class="flex-1 w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg dark:bg-gray-700">
                <span id="transparency-value" class="text-gray-700 font-mono text-sm">100%</span>
            </div>

            <!-- Layer Toggle Button -->
            <button id="toggle-layer" class="w-full px-6 py-3 bg-gray-500 text-white rounded-lg font-semibold shadow-md hover:bg-gray-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 mt-4">
                Hide Layer
            </button>
        </div>

        <!-- Map Container -->
        <div id="map"></div>
    </div>

    <!-- Toggle Panel Button -->
    <button id="toggle-panel-button" class="px-4 py-2 bg-gray-700 text-white rounded-lg shadow-md hover:bg-gray-800 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-gray-600 focus:ring-offset-2">
        &lt; Hide Controls
    </button>
    
    <script>
        window.onload = () => {
            // --- Global Variables ---
            // GIBS WMS Service URL
            const wmsServiceUrl = 'https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi?';
            const getCapabilitiesUrl = 'https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi?SERVICE=WMS&REQUEST=GetCapabilities&VERSION=1.3.0';
            
            // UI elements
            const mapDiv = document.getElementById('map');
            const dateDisplay = document.getElementById('current-date-display');
            const dateSelect = document.getElementById('date-select');
            const dateControlsContainer = document.getElementById('date-controls-container');
            const prevButton = document.getElementById('prev-day');
            const nextButton = document.getElementById('next-day');
            const layerSearch = document.getElementById('layer-search');
            const layerList = document.getElementById('layer-list');
            const loadingMessage = document.getElementById('loading-message');
            const styleSelectorContainer = document.getElementById('style-selector-container');
            const styleSelect = document.getElementById('style-select');
            const toggleLayerButton = document.getElementById('toggle-layer'); // Renamed to avoid conflict
            const transparencySlider = document.getElementById('transparency-slider');
            const transparencyValueDisplay = document.getElementById('transparency-value');
            const controlPanel = document.getElementById('control-panel');
            const togglePanelButton = document.getElementById('toggle-panel-button');

            let map;
            let nasaWmsLayer;
            let availableLayers = [];
            let currentSelectedLayerName = null;
            let currentSelectedStyleName = null;
            let currentOpacity = 1.0; // Default opacity

            // Function to format a date object to YYYY-MM-DD
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            // Function to initialize the map
            const initializeMap = () => {
                if (typeof L === 'undefined') {
                    console.error("Leaflet library not loaded. Aborting map initialization.");
                    return;
                }
                map = L.map(mapDiv).setView([25, 0], 2);

                // Add a base map layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 18,
                    attribution: 'Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>'
                }).addTo(map);
                
                // Initially hide date controls until a layer with a time dimension is selected
                dateControlsContainer.classList.add('hidden');
                toggleLayerButton.classList.add('hidden');
                transparencySlider.value = currentOpacity;
                transparencyValueDisplay.textContent = `${Math.round(currentOpacity * 100)}%`;
            };

            // Function to update the WMS layer based on the selected date and layer/style
            const updateMapLayer = () => {
                if (nasaWmsLayer) {
                    map.removeLayer(nasaWmsLayer);
                }

                if (!currentSelectedLayerName) {
                    console.warn("No layer name provided for map update.");
                    return;
                }
                
                const selectedDate = dateSelect.value;
                if (!selectedDate) {
                    // Update only if there is a selected date
                    return;
                }

                const wmsOptions = {
                    layers: currentSelectedLayerName,
                    format: 'image/jpeg',
                    transparent: false,
                    version: '1.3.0',
                    attribution: 'NASA Global Imagery Browse Services (GIBS)',
                    time: selectedDate,
                    opacity: currentOpacity // Apply current opacity
                };

                if (currentSelectedStyleName) {
                    wmsOptions.styles = currentSelectedStyleName;
                }

                nasaWmsLayer = L.tileLayer.wms(wmsServiceUrl, wmsOptions).addTo(map);
                dateDisplay.textContent = selectedDate;
                toggleLayerButton.textContent = 'Hide Layer';
            };

            // Function to parse the date dimension string and return an array of dates
            const parseDateRange = (dateString) => {
                const dates = [];
                // Check for start/end/interval format
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    let startDate = new Date(parts[0]);
                    const endDate = new Date(parts[1]);
                    // Assuming a daily interval for simplicity
                    while (startDate <= endDate) {
                        dates.push(formatDate(startDate));
                        startDate.setDate(startDate.getDate() + 1);
                    }
                } else if (dateString.includes(',')) {
                    // Check for comma-separated list
                    dates.push(...dateString.split(','));
                } else {
                    // Assume single date
                    dates.push(dateString);
                }
                return dates;
            };

            // Function to render dates to the UI dropdown
            const renderDates = (layer) => {
                dateSelect.innerHTML = '';
                dateControlsContainer.classList.add('hidden');
                
                if (layer && layer.dateRange) {
                    const dates = parseDateRange(layer.dateRange);
                    if (dates.length > 0) {
                        dates.forEach(date => {
                            const option = document.createElement('option');
                            option.value = date;
                            option.textContent = date;
                            dateSelect.appendChild(option);
                        });
                        dateControlsContainer.classList.remove('hidden');
                        dateSelect.value = dates[dates.length - 1]; // Set to the latest date
                    }
                }
            };

            // Function to render styles to the UI dropdown
            const renderStyles = (layer) => {
                styleSelect.innerHTML = '';
                styleSelectorContainer.classList.add('hidden');
                
                if (layer && layer.styles && layer.styles.length > 0) {
                    layer.styles.forEach(style => {
                        const option = document.createElement('option');
                        option.value = style.name;
                        option.textContent = style.title;
                        styleSelect.appendChild(option);
                    });
                    styleSelectorContainer.classList.remove('hidden');
                    currentSelectedStyleName = layer.styles[0].name;
                } else {
                    currentSelectedStyleName = null;
                }
            };
            
            // Function to render layers to the UI list
            const renderLayers = (layersToRender) => {
                layerList.innerHTML = '';
                if (layersToRender.length === 0) {
                    const noResults = document.createElement('li');
                    noResults.className = 'px-4 py-2 text-gray-500 italic';
                    noResults.textContent = 'No layers found.';
                    layerList.appendChild(noResults);
                    return;
                }
                
                layersToRender.forEach(layer => {
                    const li = document.createElement('li');
                    li.textContent = layer.title;
                    li.dataset.layerName = layer.name;
                    li.className = 'px-4 py-2 cursor-pointer hover:bg-gray-200 transition-colors duration-150';
                    li.addEventListener('click', () => {
                        const selectedLayer = availableLayers.find(l => l.name === li.dataset.layerName);
                        currentSelectedLayerName = selectedLayer.name;
                        
                        renderStyles(selectedLayer);
                        renderDates(selectedLayer);
                        
                        // Reset opacity to full when a new layer is selected
                        currentOpacity = 1.0;
                        transparencySlider.value = currentOpacity;
                        transparencyValueDisplay.textContent = `${Math.round(currentOpacity * 100)}%`;

                        // Wait for styles and dates to be populated before updating the map
                        setTimeout(() => updateMapLayer(), 0);

                        layerSearch.value = li.textContent;
                        layerList.style.display = 'none'; // Hide the list after selection
                        toggleLayerButton.classList.remove('hidden');
                        toggleLayerButton.textContent = 'Hide Layer';
                    });
                    layerList.appendChild(li);
                });
                layerList.style.display = 'block';
            };

            // Fetch and parse GetCapabilities XML to find layers with a time dimension and their styles
            const fetchAndParseCapabilities = async () => {
                loadingMessage.classList.remove('hidden');
                try {
                    const response = await fetch(getCapabilitiesUrl);
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    const text = await response.text();
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(text, 'text/xml');

                    const layerElements = xmlDoc.querySelectorAll('Layer > Layer');
                    availableLayers = [];

                    layerElements.forEach(layerEl => {
                        const timeDimension = layerEl.querySelector('Dimension[name="time"]');
                        if (timeDimension) {
                            const name = layerEl.querySelector('Name')?.textContent;
                            const title = layerEl.querySelector('Title')?.textContent;
                            const dateRange = timeDimension.textContent.trim();
                            if (name && title && dateRange) {
                                const styles = [];
                                layerEl.querySelectorAll('Style').forEach(styleEl => {
                                    const styleName = styleEl.querySelector('Name')?.textContent;
                                    const styleTitle = styleEl.querySelector('Title')?.textContent;
                                    if (styleName && styleTitle) {
                                        styles.push({ name: styleName, title: styleTitle });
                                    }
                                });
                                availableLayers.push({ name, title, dateRange, styles });
                            }
                        }
                    });

                    if (availableLayers.length > 0) {
                        renderLayers(availableLayers);
                        layerSearch.value = availableLayers[0].title;
                        const firstLayer = availableLayers[0];
                        currentSelectedLayerName = firstLayer.name;
                        renderStyles(firstLayer);
                        renderDates(firstLayer);
                        // Initial map load with the first layer
                        setTimeout(() => updateMapLayer(), 0);
                    } else {
                        console.error("No time-enabled layers found.");
                        const noLayerMessage = document.createElement('div');
                        noLayerMessage.textContent = "Could not find any WMS layers with a time dimension.";
                        noLayerMessage.classList.add('text-red-500', 'mt-4');
                        mapDiv.appendChild(noLayerMessage);
                    }

                } catch (error) {
                    console.error('Error fetching GetCapabilities:', error);
                    const errorMessage = document.createElement('div');
                    errorMessage.textContent = "Failed to load WMS capabilities. Check the console for more details.";
                    errorMessage.classList.add('text-red-500', 'mt-4');
                    mapDiv.appendChild(errorMessage);
                } finally {
                    loadingMessage.classList.add('hidden');
                }
            };
            
            // Event listeners
            prevButton.addEventListener('click', () => {
                const currentIndex = dateSelect.selectedIndex;
                if (currentIndex > 0) {
                    dateSelect.selectedIndex = currentIndex - 1;
                    updateMapLayer();
                }
            });

            nextButton.addEventListener('click', () => {
                const currentIndex = dateSelect.selectedIndex;
                if (currentIndex < dateSelect.options.length - 1) {
                    dateSelect.selectedIndex = currentIndex + 1;
                    updateMapLayer();
                }
            });
            
            layerSearch.addEventListener('input', (event) => {
                const searchTerm = event.target.value.toLowerCase();
                const filteredLayers = availableLayers.filter(layer => 
                    layer.title.toLowerCase().includes(searchTerm)
                );
                renderLayers(filteredLayers);
            });

            styleSelect.addEventListener('change', (event) => {
                currentSelectedStyleName = event.target.value;
                updateMapLayer();
            });

            dateSelect.addEventListener('change', () => {
                updateMapLayer();
            });

            // Transparency slider event listener
            transparencySlider.addEventListener('input', (event) => {
                currentOpacity = parseFloat(event.target.value);
                transparencyValueDisplay.textContent = `${Math.round(currentOpacity * 100)}%`;
                if (nasaWmsLayer) {
                    nasaWmsLayer.setOpacity(currentOpacity);
                }
            });

            // Toggle layer visibility
            toggleLayerButton.addEventListener('click', () => {
                if (nasaWmsLayer && map.hasLayer(nasaWmsLayer)) {
                    map.removeLayer(nasaWmsLayer);
                    toggleLayerButton.textContent = 'Show Layer';
                } else if (currentSelectedLayerName) {
                    updateMapLayer(); // Re-add layer with current settings
                    toggleLayerButton.textContent = 'Hide Layer';
                }
            });

            // Toggle control panel visibility
            togglePanelButton.addEventListener('click', () => {
                controlPanel.classList.toggle('collapsed');
                togglePanelButton.classList.toggle('panel-collapsed');
                if (controlPanel.classList.contains('collapsed')) {
                    togglePanelButton.textContent = 'Show Controls >';
                } else {
                    togglePanelButton.textContent = '< Hide Controls';
                }
                // Invalidate map size after panel transition to ensure it redraws correctly
                setTimeout(() => {
                    map.invalidateSize();
                }, 300); // Match CSS transition duration
            });


            // Hide layer list when clicking outside
            document.addEventListener('click', (event) => {
                if (!layerSearch.contains(event.target) && !layerList.contains(event.target)) {
                    layerList.style.display = 'none';
                } else {
                    layerList.style.display = 'block';
                }
            });

            // Initial setup
            initializeMap();
            fetchAndParseCapabilities();
        };
    </script>
</body>
</html>
